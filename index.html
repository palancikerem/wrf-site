<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerem Palancı WRF Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f0f;
            --panel-bg: #1a1a1a;
            --text-color: #efefef;
            --accent: #0081ff;
            --accent-hover: #0056b3;
            --border: #2a2a2a;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ÜST PANEL */
        .controls {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .logo-box {
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .sub-logo {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.6;
        }

        .select-group {
            display: flex;
            gap: 8px;
        }

        select, button {
            background-color: #252525;
            color: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        select:hover, button:hover {
            border-color: var(--accent);
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 129, 255, 0.2);
        }

        button.active {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        /* GÖRSEL ALANI */
        .viewer {
            flex: 1;
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .viewer img {
            max-width: 98%;
            max-height: 98%;
            object-fit: contain;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            user-select: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 5;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .error-msg {
            position: absolute;
            color: #ff5252;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 12px;
            display: none;
            text-align: center;
            border: 1px solid #ff5252;
            max-width: 400px;
        }

        /* ALT ZAMAN ÇUBUĞU */
        .timeline {
            background-color: var(--panel-bg);
            padding: 15px 25px;
            border-top: 1px solid var(--border);
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #dateDisplay { color: var(--accent); }
        #frameDisplay { opacity: 0.5; }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent);
            height: 6px;
            border-radius: 3px;
        }

        @media (max-width: 900px) {
            .controls { flex-direction: column; gap: 10px; padding: 15px; }
            .select-group { width: 100%; flex-direction: column; }
            .btn-group { width: 100%; display: flex; }
            .btn-group button { flex: 1; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="logo-box">
            <div class="logo">WRF-ARW Kerem Palancı</div>
            <div class="sub-logo">GFS 0.25° ➔ 6km WRF</div>
        </div>
        
        <div class="select-group">
            <select id="regionSelect">
                <option value="TR" selected>Türkiye Geneli</option>
                <option value="MARMARA">Marmara & Batı Karadeniz</option>
                <option value="EGE">Ege Bölgesi</option>
                <option value="AKDENIZ">Akdeniz Bölgesi</option>
                <option value="KARADENIZ">Orta & Doğu Karadeniz</option>
                <option value="DOGU_ANADOLU">Doğu & Güneydoğu Anadolu</option>
                <option value="IC_ANADOLU">İç Anadolu Bölgesi</option>
            </select>

            <select id="varSelect">
                <optgroup label="Yüzey Parametreleri">
                    <option value="T2" selected>2m Sıcaklık (°C)</option>
                    <option value="HEAT_INDEX">Hissedilen Sıcaklık (°C)</option>
                    <option value="RAIN">Toplam Yağış (mm)</option>
                    <option value="RAIN1H">Saatlik Yağış (mm)</option>
                    <option value="UVMET10">10m Rüzgar Hamlesi (km/h)</option>
                    <option value="SLP">Basınç (MSLP - hPa)</option>
                </optgroup>
                <optgroup label="Kar Verileri">
                    <option value="SNOW">Toplam Kar Yağışı (cm)</option>
                    <option value="SNOWDEPTH">Kar Derinliği (cm)</option>
                </optgroup>
                <optgroup label="Üst Seviye Envanteri">
                    <option value="TEMP_850">850 hPa Sıcaklık</option>
                    <option value="TEMP_500">500 hPa Sıcaklık</option>
                </optgroup>
                <optgroup label="Kararsızlık & Radar">
                    <option value="CAPE">SBCAPE (J/kg)</option>
                    <option value="MDBZ">Simüle Radar (dBZ)</option>
                </optgroup>
            </select>
        </div>

        <div class="btn-group">
            <button id="prevBtn">❮</button>
            <button id="playBtn">▶ Oynat</button>
            <button id="nextBtn">❯</button>
        </div>
    </div>

    <div class="viewer">
        <div class="loading" id="loader">İşleniyor...</div>
        <div class="error-msg" id="errorMsg">
            <h3>VERİ BULUNAMADI</h3>
            <p id="errorDetail">Bu saat/parametre kombinasyonu henüz hazır değil.</p>
        </div>
        <img id="mapImage" src="" alt="WRF Model Haritası">
    </div>

    <div class="timeline">
        <div class="info-bar">
            <span id="dateDisplay">Hazırlanıyor...</span>
            <span id="frameDisplay">0 / 0</span>
        </div>
        <input type="range" id="timeSlider" min="0" value="0" step="1">
    </div>

    <script>
        const elements = {
            img: document.getElementById('mapImage'),
            region: document.getElementById('regionSelect'),
            variable: document.getElementById('varSelect'),
            slider: document.getElementById('timeSlider'),
            dateDisp: document.getElementById('dateDisplay'),
            frameDisp: document.getElementById('frameDisplay'),
            playBtn: document.getElementById('playBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            loader: document.getElementById('loader'),
            errorMsg: document.getElementById('errorMsg'),
            errorDetail: document.getElementById('errorDetail')
        };

        let availableTimes = [];
        let isPlaying = false;
        let playInterval;
        const animationSpeed = 400; // ms

        async function init() {
            try {
                // images klasöründeki file_list.json çekiliyor
                const response = await fetch('./images/file_list.json?t=' + Date.now());
                if (!response.ok) throw new Error("Dosya listesi (JSON) sunucuda bulunamadı.");
                
                availableTimes = await response.json();
                availableTimes.sort();

                if (availableTimes.length === 0) {
                    showError("JSON boş. Henüz hiçbir harita üretilmemiş.");
                    return;
                }

                elements.slider.max = availableTimes.length - 1;
                elements.slider.value = 0;

                // Event Listeners
                elements.slider.oninput = updateMap;
                elements.region.onchange = updateMap;
                elements.variable.onchange = updateMap;
                elements.playBtn.onclick = togglePlay;
                elements.prevBtn.onclick = () => step(-1);
                elements.nextBtn.onclick = () => step(1);

                // Keyboard
                document.onkeydown = (e) => {
                    if (e.key === 'ArrowLeft') step(-1);
                    if (e.key === 'ArrowRight') step(1);
                    if (e.key === ' ') { e.preventDefault(); togglePlay(); }
                };

                updateMap();

            } catch (error) {
                showError(error.message);
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return "";
            // Format: YYYYMMDD_HHMMSS -> DD.MM.YYYY HH:MM
            const y = timeStr.substring(0, 4);
            const m = timeStr.substring(4, 6);
            const d = timeStr.substring(6, 8);
            const h = timeStr.substring(9, 11);
            const min = timeStr.substring(11, 13);
            return `${d}.${m}.${y} ${h}:${min} UTC`;
        }

        function updateMap() {
            if (availableTimes.length === 0) return;

            const idx = parseInt(elements.slider.value);
            const time = availableTimes[idx];
            const reg = elements.region.value;
            const varCode = elements.variable.value;

            // Python formatıyla tam uyum: {Region}_{Var}_{Time}.png
            const url = `./images/${reg}_${varCode}_${time}.png`;

            elements.dateDisp.innerText = formatTime(time);
            elements.frameDisp.innerText = `KARE: ${idx + 1} / ${availableTimes.length}`;
            elements.loader.style.display = 'block';
            elements.errorMsg.style.display = 'none';

            const imgLoader = new Image();
            imgLoader.onload = () => {
                elements.img.src = url;
                elements.loader.style.display = 'none';
            };
            imgLoader.onerror = () => {
                elements.loader.style.display = 'none';
                elements.errorMsg.style.display = 'block';
                elements.errorDetail.innerText = `${url} bulunamadı.`;
            };
            imgLoader.src = url;
        }

        function step(dir) {
            let v = parseInt(elements.slider.value) + dir;
            if (v >= availableTimes.length) v = 0;
            if (v < 0) v = availableTimes.length - 1;
            elements.slider.value = v;
            updateMap();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            elements.playBtn.innerHTML = isPlaying ? "❚❚ Durdur" : "▶ Oynat";
            elements.playBtn.classList.toggle('active', isPlaying);
            if (isPlaying) playInterval = setInterval(() => step(1), animationSpeed);
            else clearInterval(playInterval);
        }

        function showError(msg) {
            elements.errorMsg.style.display = 'block';
            elements.errorDetail.innerText = msg;
            elements.loader.style.display = 'none';
        }

        init();
    </script>
</body>
</html>
